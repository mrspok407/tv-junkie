/* eslint-disable max-len */
import React, { useEffect, useState } from 'react'
import axios from 'axios'
import { Helmet } from 'react-helmet'
import Header from 'Components/UI/Header/Header'
import ScrollToTop from 'Utils/ScrollToTopBar'
import Footer from 'Components/UI/Footer/Footer'
import { MainDataTMDB } from 'Utils/@TypesTMDB'
import useGoogleRedirect from 'Components/UserAuth/SignIn/UseGoogleRedirect'
import MoviesContent from './MoviesContent'

const { CancelToken } = require('axios')

let cancelRequest: any

const Movies: React.FC = () => {
  const [moviesData, setMoviesData] = useState<MainDataTMDB[]>([])
  const [loadingIds, setLoadingIds] = useState<number[]>([])
  const [openLinksMoviesId, setOpenLinksMoviesId] = useState<number[]>([])
  const [error, setError] = useState<number[]>([])

  useGoogleRedirect()

  useEffect(
    () => () => {
      if (cancelRequest !== undefined) cancelRequest()
    },
    [],
  )

  const getMovieLinks = ({ id }: { id: number }) => {
    if (openLinksMoviesId.includes(id)) return

    setLoadingIds((prevState) => [...prevState, id])
    setOpenLinksMoviesId((prevState) => [...prevState, id])

    axios
      .get(
        `https://api.themoviedb.org/3/movie/${id}?api_key=${process.env.REACT_APP_TMDB_API}&language=en-US&append_to_response=similar_movies,external_ids`,
        {
          cancelToken: new CancelToken((c: any) => {
            cancelRequest = c
          }),
        },
      )
      .then(({ data: { external_ids } }) => {
        const imdbId = external_ids.imdb_id
        return axios.get(`https://yts.mx/api/v2/list_movies.json?query_term=${imdbId}`, {
          cancelToken: new CancelToken((c: any) => {
            cancelRequest = c
          }),
        })
      })
      .then((res) => {
        const movie = res.data.data.movies[0]
        movie.id = id

        setMoviesData((prevState) => [...prevState, movie])
        setLoadingIds((prevState) => [...prevState.filter((item: number) => item !== id)])
      })
      .catch((error) => {
        if (axios.isCancel(error)) return
        setError((prevState) => [...prevState, id])
      })
  }

  return (
    <>
      <Helmet>
        <title>All your movies | TV Junkie</title>
      </Helmet>
      <Header />
      <MoviesContent
        moviesData={moviesData}
        getMovieLinks={getMovieLinks}
        loadingIds={loadingIds}
        openLinksMoviesId={openLinksMoviesId}
        error={error}
      />
      <Footer />
      <ScrollToTop />
    </>
  )
}

export default Movies
